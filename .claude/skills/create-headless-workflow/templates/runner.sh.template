#!/bin/bash
set -euo pipefail

# {{description}}
# Generated by create-headless-workflow skill

PROJECT_PATH="$(cd "$(dirname "$0")/.." && pwd)"
LOG_FILE="$PROJECT_PATH/{{name}}-log.md"
LOCK_FILE="/tmp/{{name}}.lock"

# Prevent concurrent runs
if [ -f "$LOCK_FILE" ]; then
    PID=$(cat "$LOCK_FILE")
    if kill -0 "$PID" 2>/dev/null; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Skipped: previous run (PID $PID) still active" >> "$LOG_FILE"
        exit 0
    fi
    rm -f "$LOCK_FILE"
fi
echo $$ > "$LOCK_FILE"
trap 'rm -f "$LOCK_FILE"' EXIT

cd "$PROJECT_PATH" || exit 1

# Log run start
echo "" >> "$LOG_FILE"
echo "---" >> "$LOG_FILE"
echo "## Run: $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# Run Claude headless â€” the skill handles git commit/merge/push internally
claude -p "Proceed with {{name}}" \
  --model {{model}} \
  --permission-mode {{permission_mode}} \
  --allowedTools "{{allowed_tools}}" 2>&1 | tee -a "$LOG_FILE"

echo "Completed at: $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
